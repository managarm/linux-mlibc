imports:
  - file: bootstrap.d/app-accessibility.y4.yml
  - file: bootstrap.d/app-arch.y4.yml
  - file: bootstrap.d/app-crypt.y4.yml
  - file: bootstrap.d/app-editors.y4.yml
  - file: bootstrap.d/app-emulation.y4.yml
  - file: bootstrap.d/app-misc.y4.yml
  - file: bootstrap.d/app-shells.y4.yml
  - file: bootstrap.d/app-text.y4.yml
  - file: bootstrap.d/dev-db.y4.yml
  - file: bootstrap.d/dev-lang.y4.yml
  - file: bootstrap.d/dev-libs.y4.yml
  - file: bootstrap.d/dev-qt.y4.yml
  - file: bootstrap.d/dev-tcltk.y4.yml
  - file: bootstrap.d/dev-util.y4.yml
  - file: bootstrap.d/games-board.y4.yml
  - file: bootstrap.d/games-misc.y4.yml
  - file: bootstrap.d/gnome-base.y4.yml
  - file: bootstrap.d/gui-apps.y4.yml
  - file: bootstrap.d/gui-libs.y4.yml
  - file: bootstrap.d/gui-wm.y4.yml
  - file: bootstrap.d/media-fonts.y4.yml
  - file: bootstrap.d/media-gfx.y4.yml
  - file: bootstrap.d/media-libs.y4.yml
  - file: bootstrap.d/net-dns.y4.yml
  - file: bootstrap.d/net-libs.y4.yml
  - file: bootstrap.d/net-misc.y4.yml
  - file: bootstrap.d/sys-apps.y4.yml
  - file: bootstrap.d/sys-auth.y4.yml
  - file: bootstrap.d/sys-boot.y4.yml
  - file: bootstrap.d/sys-devel.y4.yml
  - file: bootstrap.d/sys-fs.y4.yml
  - file: bootstrap.d/sys-libs.y4.yml
  - file: bootstrap.d/sys-process.y4.yml
  - file: bootstrap.d/tasks.y4.yml
  - file: bootstrap.d/tools.y4.yml
  - file: bootstrap.d/www-client.y4.yml
  - file: bootstrap.d/x11-apps.y4.yml
  - file: bootstrap.d/x11-base.y4.yml
  - file: bootstrap.d/x11-libs.y4.yml
  - file: bootstrap.d/x11-misc.y4.yml
  - file: bootstrap.d/x11-themes.y4.yml

sources:
  - name: pkg-config
    subdir: ports
    git: 'https://gitlab.freedesktop.org/pkg-config/pkg-config.git'
    tag: 'pkg-config-0.29.2'
    version: '0.29.2'
    tools_required:
      - cross-autoconf-v2.69
      - cross-automake-v1.15
      - cross-libtool
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: binutils
    subdir: 'ports'
    git: 'https://github.com/managarm/binutils-gdb.git'
    tag: 'managarm/binutils-2_43_1'
    version: '2.43.1'

  - name: gcc
    subdir: ports
    git: 'https://github.com/managarm/gcc.git'
    tag: 'managarm/gcc-14_2_0'
    version: '14.2.0'
    tools_required:
      - cross-autoconf-v2.69
      - cross-automake-v1.11
    regenerate:
      - args: ['autoconf']
        workdir: '@THIS_SOURCE_DIR@/libstdc++-v3'

  - name: linux
    subdir: ports
    url: 'https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.8.tar.xz'
    checksum: 'blake2b:62a3f435bbe7d24bea361f2545ba50f8b36030a98bd28d0979b86052d8af34dc7a4c27f7ca2890daba5e5bb51f5848e6b21cd5df4dbbd19919867bf67d38790d'
    extract_path: 'linux-6.12.8'
    format: 'tar.xz'
    version: '6.12.8'

  - name: mlibc
    git: 'https://github.com/managarm/mlibc.git'
    branch: 'master'
    commit: '5bc20bde80bbffe1cdd5a2c421279314440728ce'
    rolling_version: true
    version: '0.0pl@ROLLING_ID@'
    # sources_required:
    #   - libdrm
    #   - managarm
    #   - bragi
    # regenerate:
    #   - args: ['ln', '-sf', '@SOURCE_ROOT@/managarm', '@THIS_SOURCE_DIR@/subprojects/']
    #   - args: ['ln', '-sf', '@SOURCE_ROOT@/ports/bragi', '@THIS_SOURCE_DIR@/subprojects/']

  - name: gnuconfig
    subdir: 'ports'
    git: 'https://https.git.savannah.gnu.org/git/config.git'
    branch: 'master'
    commit: '63acb96f92473ceb5e21d873d7c0aee266b3d6d3'
    version: '20230121'

tools:
  - name: host-iasl
    labels: [aarch64, riscv64]
    architecture: noarch
    source:
      subdir: ports
      checksum: 'blake2b:6f4b4e329e87875eb14cf45b36f6213943b4c7da6fa7345ec2e888d567b067d243717cdf86b543e64120c27c3ef378eeedbae80fcc620140d549bc7a6fb53f5e'
      url: https://github.com/user-attachments/files/17171017/acpica-unix2-20240927.tar.gz
      format: tar.gz
      extract_path: 'acpica-unix2-20240927'
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
    compile:
      - args: ['make', 'iasl']
    install:
      - args: ['make', 'install', 'PREFIX=@PREFIX@']

  - name: ovmf
    labels: [aarch64, riscv64]
    architecture: '@OPTION:arch@'
    source:
      subdir: ports
      git: 'https://github.com/tianocore/edk2.git'
      tag: 'edk2-stable202408'
      version: '2024.08'
      patch_keep_crlf: true
      # don't judge, submodules are borked so we gotta do it manually
      # which is why we need to run this in regenerate instead of checkout
      regenerate:
        - args:
          - 'git'
          - 'submodule'
          - 'update'
          - '--init'
          - 'BaseTools/Source/C/BrotliCompress/brotli'
          - 'CryptoPkg/Library/MbedTlsLib/mbedtls'
          - 'CryptoPkg/Library/OpensslLib/openssl'
          - 'MdeModulePkg/Library/BrotliCustomDecompressLib/brotli'
          - 'MdeModulePkg/Universal/RegularExpressionDxe/oniguruma'
          - 'MdePkg/Library/BaseFdtLib/libfdt'
          - 'MdePkg/Library/MipiSysTLib/mipisyst'
          - 'RedfishPkg/Library/JsonLib/jansson'
          - 'SecurityPkg/DeviceSecurity/SpdmLib/libspdm'
          - 'ArmPkg/Library/ArmSoftFloatLib/berkeley-softfloat-3'
          isolate_network: false
    tools_required:
      - host-llvm-toolchain
      - host-python
      - host-iasl
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
    compile:
      - args: |
          OVMF_ARCH=""
          OVMF_PKG=""
          case "@OPTION:arch@" in
            "x86_64")
              OVMF_ARCH="X64"
              OVMF_PKG="OvmfPkg/OvmfPkgX64"
              ;;
            "aarch64")
              OVMF_ARCH="AARCH64"
              OVMF_PKG="ArmVirtPkg/ArmVirtQemu"
              ;;
            "riscv64")
              OVMF_ARCH="RISCV64"
              OVMF_PKG="OvmfPkg/RiscVVirt/RiscVVirtQemu"
              ;;
            *)
              echo "Unhandled architecture"
              exit 1
              ;;
          esac
          . @THIS_BUILD_DIR@/edksetup.sh
          make -C @THIS_BUILD_DIR@/BaseTools
          build -a $OVMF_ARCH -b DEBUG -p $OVMF_PKG.dsc -t CLANGDWARF -DNETWORK_HTTP_BOOT_ENABLE
        environ:
          PYTHON_COMMAND: 'python3'
    install:
      - args: |
          ARCH="@OPTION:arch@"
          TRUNCATE_SIZE=""
          case "$ARCH" in
            "x86_64")
              OVMF_CODE="OvmfX64/DEBUG_CLANGDWARF/FV/OVMF_CODE.fd"
              OVMF_VARS="OvmfX64/DEBUG_CLANGDWARF/FV/OVMF_VARS.fd"
              ;;
            "aarch64")
              OVMF_CODE="ArmVirtQemu-AARCH64/DEBUG_CLANGDWARF/FV/QEMU_EFI.fd"
              OVMF_VARS="ArmVirtQemu-AARCH64/DEBUG_CLANGDWARF/FV/QEMU_VARS.fd"
              TRUNCATE_SIZE="64M"
              ;;
            "riscv64")
              OVMF_CODE="RiscVVirtQemu/DEBUG_CLANGDWARF/FV/RISCV_VIRT_CODE.fd"
              OVMF_VARS="RiscVVirtQemu/DEBUG_CLANGDWARF/FV/RISCV_VIRT_VARS.fd"
              TRUNCATE_SIZE="32M"
              ;;
            *)
              echo "Unhandled architecture"
              exit 1
              ;;
          esac
          cp "@THIS_BUILD_DIR@/Build/$OVMF_CODE" @PREFIX@/OVMF_CODE_@OPTION:arch@.fd
          cp "@THIS_BUILD_DIR@/Build/$OVMF_VARS" @PREFIX@/OVMF_VARS_@OPTION:arch@.fd
          if [[ ! -z $TRUNCATE_SIZE ]]; then
            truncate -s $TRUNCATE_SIZE @PREFIX@/OVMF_CODE_@OPTION:arch@.fd
            truncate -s $TRUNCATE_SIZE @PREFIX@/OVMF_VARS_@OPTION:arch@.fd
          fi
          mkdir @PREFIX@/bin
          cp "@THIS_BUILD_DIR@/BaseTools/Source/C/bin/GenFw" "@PREFIX@/bin/"

  - name: cross-pkg-config
    architecture: '@OPTION:arch@'
    exports_aclocal: true
    from_source: pkg-config
    revision: 1
    configure:
      - args: ['@THIS_SOURCE_DIR@/configure', '--prefix=@PREFIX@', '--with-internal-glib']
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']

  - name: cross-binutils
    architecture: '@OPTION:arch@'
    from_source: binutils
    tools_required:
      - cross-automake-v1.15
    revision: 1
    configure:
      - args:
          - '@THIS_SOURCE_DIR@/configure'
          - '--prefix=@PREFIX@'
          - '--with-sysroot=@SYSROOT_DIR@'
          - '--target=@OPTION:arch-triple@'
          - '--disable-nls'
          - '--disable-werror'
          - '--disable-gdb'
    compile:
      - args: ['make', '-j@PARALLELISM@', 'all-binutils', 'all-gas', 'all-ld']
    install:
      - args: ['make', 'install-binutils', 'install-gas', 'install-ld']

  - name: cross-gcc
    architecture: '@OPTION:arch@'
    from_source: gcc
    tools_required:
      - cross-binutils
    revision: 1
    configure:
      - args:
          - '@THIS_SOURCE_DIR@/configure'
          - '--prefix=@PREFIX@'
          - '--with-sysroot=@SYSROOT_DIR@'
          - '--target=@OPTION:arch-triple@'
          - '--enable-languages=c,c++'
          - '--disable-multilib'
          - '--disable-nls'
          - '--enable-initfini-array'
          - '--enable-libstdcxx-filesystem-ts'
    stages:
      - name: compiler
        pkgs_required:
          - mlibc-headers
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-gcc']
        install:
          - args: ['make', 'install-gcc']
          - args: ['mkdir', '-p', '@PREFIX@/@OPTION:arch-triple@/bin']
          - args: ['ln', '-sf', '../../../cross-binutils/@OPTION:arch-triple@/bin/as', '@PREFIX@/@OPTION:arch-triple@/bin/as']
          - args: ['ln', '-sf', '../../../cross-binutils/@OPTION:arch-triple@/bin/ld', '@PREFIX@/@OPTION:arch-triple@/bin/ld']
      - name: libgcc
        tools_required:
          - tool: cross-gcc
            stage_dependencies: [compiler]
        pkgs_required:
          - mlibc
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-target-libgcc']
        install:
          - args: ['make', 'install-target-libgcc']
      - name: libstdc++
        tools_required:
          - tool: cross-gcc
            stage_dependencies: [libgcc]
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-target-libstdc++-v3']
        install:
          - args: ['make', 'install-strip-target-libstdc++-v3']

  - name: cross-toolchain
    architecture: '@OPTION:arch@'
    source:
      subdir: meta-sources
      version: '1.0'
    tools_required:
      - tool: cross-autoconf-v2.69
        recursive: true
      - tool: cross-automake-v1.15
        recursive: true
      - tool: cross-binutils
        recursive: true
      - tool: cross-gcc
        recursive: true
      - tool: cross-pkg-config
        recursive: true
      - tool: cross-libtool
        recursive: true
    revision: 1
    configure: []
    compile: []
    install: []

packages:
  - name: base-files
    architecture: '@OPTION:arch@'
    implict_package: true
    source:
      subdir: meta-sources
      version: '1.0'
    default: true
    revision: 1
    build:
      - args: |
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}{bin,include,lib,sbin,src}
          ln -sfv usr/bin @THIS_COLLECT_DIR@/bin
          ln -sfv usr/lib @THIS_COLLECT_DIR@/lib
          ln -sfv usr/sbin @THIS_COLLECT_DIR@/sbin
          mkdir -pv @THIS_COLLECT_DIR@/{boot,home,mnt,opt,srv}
          mkdir -pv @THIS_COLLECT_DIR@/etc/{opt,sysconfig}
          mkdir -pv @THIS_COLLECT_DIR@/lib/firmware
          mkdir -pv @THIS_COLLECT_DIR@/media/{floppy,cdrom}
          mkdir -pv @THIS_COLLECT_DIR@/usr/local/{bin,lib,sbin}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/{color,dict,doc,info,locale,man}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/{misc,terminfo,zoneinfo}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/man/man{1..8}
          mkdir -pv @THIS_COLLECT_DIR@/var/{cache,local,log,mail,opt,spool}
          mkdir -pv @THIS_COLLECT_DIR@/var/lib/{color,misc,locate}
          install -dv -m 0750 @THIS_COLLECT_DIR@/root
          install -dv -m 1777 @THIS_COLLECT_DIR@/tmp @THIS_COLLECT_DIR@/var/tmp
          install --directory --mode=0755 @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/{group,hosts,passwd,profile,bashrc,dircolors,shells,inputrc,hostname,resolv.conf} @THIS_COLLECT_DIR@/etc
          cp @THIS_SOURCE_DIR@/bash_completion.sh @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/dircolors.sh @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/extrapaths.sh @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/readline.sh @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/umask.sh @THIS_COLLECT_DIR@/etc/profile.d
          cp @THIS_SOURCE_DIR@/bashrc @THIS_COLLECT_DIR@/root/.bashrc
          cp @THIS_SOURCE_DIR@/post-boot-fixup.sh @THIS_COLLECT_DIR@/root
          install --directory --mode=0755 @THIS_COLLECT_DIR@/etc/bash_completion.d
          touch @THIS_COLLECT_DIR@/{boot,home,mnt,opt,root,srv,tmp}/.keep
          touch @THIS_COLLECT_DIR@/etc/{opt,sysconfig}/.keep
          touch @THIS_COLLECT_DIR@/etc/bash_completion.d/.keep
          touch @THIS_COLLECT_DIR@/lib/firmware/.keep
          touch @THIS_COLLECT_DIR@/media/{floppy,cdrom}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}{bin,include,lib,sbin,src}/.keep
          touch @THIS_COLLECT_DIR@/usr/local/{bin,lib,sbin}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/{color,dict,doc,info,locale,man}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/{misc,terminfo,zoneinfo}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/man/man{1..8}/.keep
          touch @THIS_COLLECT_DIR@/var/{cache,local,log,mail,opt,spool}/.keep
          touch @THIS_COLLECT_DIR@/var/lib/{color,misc,locate}/.keep
          touch @THIS_COLLECT_DIR@/{tmp,var/tmp}/.keep
          ln -sfv /run @THIS_COLLECT_DIR@/var/run
          ln -sfv /run/lock @THIS_COLLECT_DIR@/var/lock

  - name: kernel-headers
    architecture: '@OPTION:arch@'
    from_source: linux
    implict_package: true
    revision: 1
    configure:
      - args: ['rsync', '-ar', '@THIS_SOURCE_DIR@/', '@THIS_BUILD_DIR@/']
    build:
      - args: ['make', 'mrproper', 'headers']
      - args: ['find', 'usr/include', '-name', '".*"', '-delete']
      - args: ['rm', 'usr/include/Makefile']
      - args: ['mkdir', '-pv', '@THIS_COLLECT_DIR@/usr']
      - args: ['cp', '-rv', 'usr/include', '@THIS_COLLECT_DIR@/usr']

  - name: kernel
    architecture: '@OPTION:arch@'
    from_source: linux
    tools_required:
      - tool: cross-gcc
    revision: 1
    configure:
      - args: ['rsync', '-ar', '@THIS_SOURCE_DIR@/', '@THIS_BUILD_DIR@/']
      - args: ['make', 'mrproper']
      - args: ['cp', '@SOURCE_ROOT@/scripts/kernel.config', '@THIS_BUILD_DIR@/.config']
      - args: ['make', 'olddefconfig']
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'modules_install']
        environ:
          INSTALL_MOD_PATH: '@THIS_COLLECT_DIR@/usr/'
      - args: ['mkdir', '-pv', '@THIS_COLLECT_DIR@/boot']
      - args: ['cp', '-v', '@THIS_BUILD_DIR@/arch/x86/boot/bzImage', '@THIS_COLLECT_DIR@/boot/vmlinuz-linux']

  - name: mlibc-headers
    architecture: '@OPTION:arch@'
    from_source: mlibc
    implict_package: true
    pkgs_required:
      - kernel-headers
    revision: 1
    configure:
      - args:
          - 'meson'
          - 'setup'
          - '--cross-file'
          - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
          - '--prefix=/usr'
          - '-Dheaders_only=true'
          - '-Dbuildtype=debug'
          - '-Dlinux_kernel_headers=@SYSROOT_DIR@/usr/include'
          - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: mlibc
    architecture: '@OPTION:arch@'
    from_source: mlibc
    tools_required:
      - tool: cross-gcc
        stage_dependencies: [compiler]
      - tool: cross-binutils
    implict_package: true
    pkgs_required:
      - mlibc-headers
    revision: 1
    configure:
      - args: |
          curl -Lo libgcc-x86_64.a https://github.com/osdev0/libgcc-binaries/releases/download/2025-08-21/libgcc-x86_64.a
          b2sum libgcc-x86_64.a | grep -q f41054803d2c8475ca394b37e4368aa7ae900bb73409f3d9566b4348797a16efadc97e28ed5db1432c30ba8c4b5ae8fb5ff42ec6d77c2f749765cac89bd66b56
      - args:
          - 'meson'
          - 'setup'
          - '--cross-file'
          - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
          - '--prefix=/usr'
          - '--libdir=lib'
          - '-Dno_headers=true'
          - '-Dlibgcc_dependency=false'
          - '-Dbuildtype=debug'
          - '-Dlinux_kernel_headers=@SYSROOT_DIR@/usr/include'
          - '-Dld_library_name=ld-linux-mlibc'
          - '-Duse_freestnd_hdrs=enabled'
          - '@THIS_SOURCE_DIR@'
        environ:
          LDFLAGS: '-Wl,@THIS_BUILD_DIR@/libgcc-x86_64.a'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

# TODO: We currently don't support computed options or anything of that sort,
#       so we just define the architecture, and the triple as 2 options
#       (some packages, like llvm and libjpeg-turbo need the architecture)
declare_options:
  - name: arch
    default: x86_64
  - name: arch-triple
    default: x86_64-linux-mlibc
  - name: mount-using
    default: guestfs
  - name: image-size
    default: 4G
  - name: rust-arch
    default: x86_64
