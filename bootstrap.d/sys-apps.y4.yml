sources:
  - name: coreutils
    subdir: 'ports'
    url: 'https://ftpmirror.gnu.org/gnu/coreutils/coreutils-9.6.tar.xz'
    format: tar.xz
    checksum: 'blake2b:4070d3d272851d3e9c326df9c05ce67797d86852e7f5c26e545f987f444295f2cfca24e8569514d7b5edf8fd50318d07cb20dea4a4ce8c65b34bea0c5a9177be'
    extract_path: 'coreutils-9.6'
    version: '9.6'
    tools_required:
      - cross-automake-v1.15
    regenerate:
      - args: ['cp', '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub', '@THIS_SOURCE_DIR@/build-aux/']

  - name: file
    subdir: ports
    git: 'https://github.com/file/file.git'
    tag: 'FILE5_46'
    version: '5.46'
    tools_required:
      - cross-autoconf-v2.69
      - cross-automake-v1.15
      - cross-libtool
    regenerate:
      - args: ['autoreconf', '-f', '-i']

  - name: util-linux
    subdir: ports
    git: 'https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git'
    tag: 'v2.41.3'
    version: '2.41.3'

tools:
  - name: cross-file
    architecture: '@OPTION:arch@'
    from_source: file
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']

packages:
  - name: acl
    architecture: '@OPTION:arch@'
    metadata:
      summary: Access control list utilities, libraries, and headers
      description: This package contains utilities to administer Access Control Lists, which are used to define fine-grained discretionary access rights for files and directories.
      spdx: 'LGPL-2.1-or-later'
      website: 'https://savannah.nongnu.org/projects/acl'
      maintainer: 'Dennis Bonke <dennis@managarm.org>'
      categories: ['sys-apps']
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/acl.git'
      tag: 'v2.3.2'
      version: '2.3.2'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - attr
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--docdir=/usr/share/doc/acl-2.3.2'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: attr
    architecture: '@OPTION:arch@'
    metadata:
      summary: Extended attributes tools
      description: This package contains utilities to administer the extended attributes of filesystem objects.
      spdx: 'LGPL-2.1-or-later'
      website: 'https://savannah.nongnu.org/projects/attr'
      maintainer: 'Dennis Bonke <dennis@managarm.org>'
      categories: ['sys-apps']
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/attr.git'
      tag: 'v2.5.2'
      version: '2.5.2'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--docdir=/usr/share/doc/attr-2.5.2'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: bootscripts
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      url: 'https://www.linuxfromscratch.org/lfs/downloads/11.2/lfs-bootscripts-20220723.tar.xz'
      format: 'tar.xz'
      extract_path: 'lfs-bootscripts-20220723'
      version: '20220723'
      patch-path-strip: 1
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
    build:
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: coreutils
    architecture: '@OPTION:arch@'
    metadata:
      summary: Standard GNU utilities (chmod, cp, dd, ls, sort, tr, head, wc, who,...)
      description: This package contains the basic utility programs needed by every operating system.
      spdx: 'GPL-3.0-or-later'
      website: 'https://www.gnu.org/software/coreutils/'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['sys-apps']
    from_source: coreutils
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - acl
      - attr
      - libiconv
    revision: 1
    configure:
      - args:
          - '@THIS_SOURCE_DIR@/configure'
          - '--host=@OPTION:arch-triple@'
          - '--prefix=/usr'
          - '--enable-install-program=hostname'
          - '--enable-no-install-program=kill,uptime'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']

  - name: dbus
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://gitlab.freedesktop.org/dbus/dbus.git'
      tag: 'dbus-1.12.20'
      version: '1.12.20'
      tools_required:
        - cross-toolchain
        - cross-autoconf-archive
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - cross-toolchain
      - host-python
      - virtual: pkgconfig-for-target
        triple: '@OPTION:arch-triple@'
    pkgs_required:
      - mlibc
      - glib
      - libexpat
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        #- '--enable-user-session'
        - '--disable-doxygen-docs'
        - '--disable-xml-docs'
        - '--disable-static'
        - '--enable-shared'
        - '--enable-verbose-mode'
        - '--with-systemdsystemunitdir=no'
        - '--with-systemduserunitdir=no'
        - '--docdir=/usr/share/doc/dbus-1.12.20'
        - '--with-console-auth-dir=/run/console'
        - '--with-system-pid-file=/run/dbus/pid'
        - '--with-system-socket=/run/dbus/system_bus_socket'
        - '--disable-selinux'
        - '--disable-apparmor'
        - '--disable-libaudit'
        - '--disable-kqueue'
        - '--disable-launchd'
        - '--disable-systemd'
        - '--disable-tests'
    build:
      # Copy dbus-arch-deps.h into /usr/include/dbus-1.0/dbus?
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: diffutils
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/diffutils.git'
      tag: 'v3.11'
      version: '3.11'
      sources_required:
        - gnulib
      tools_required:
        - cross-autoconf-v2.69
        - cross-automake-v1.15
      regenerate:
        - args: ['python3', '@SOURCE_ROOT@/scripts/checkout-gnulib.py', '@SOURCE_ROOT@/ports/gnulib']
        - args: ['./bootstrap', '--skip-po']
        - args: ["cp", "@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub", "@THIS_SOURCE_DIR@/build-aux/"]
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-nls'
        - '--disable-werror'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/lib/Makefile'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/src/Makefile'
    build:
      - args: ['make', '-j', '@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: file
    architecture: '@OPTION:arch@'
    metadata:
      summary: Identify a file's format by scanning binary data for patterns
      description: This package contains an utility for determining the type of a given file or files.
      spdx: 'BSD-2-Clause'
      website: 'https://www.darwinsys.com/file/'
      maintainer: 'Dennis Bonke <dennis@managarm.org>'
      categories: ['sys-apps']
    from_source: file
    tools_required:
      - cross-toolchain
      - cross-file
    pkgs_required:
      - mlibc
      - zlib
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-bzlib'
        - '--disable-xzlib'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: findutils
    labels: [aarch64, riscv64]
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    metadata:
      summary: GNU utilities for finding files
      description: This package contains programs to find files. Programs are provided to search through all the files in a directory tree and to create, maintain, and search a database.
      spdx: 'GPL-3.0-or-later'
      website: 'https://www.gnu.org/software/findutils/'
      maintainer: 'Dennis Bonke <dennis@managarm.org>'
      categories: ['sys-apps']
    source:
      subdir: ports
      git: 'https://https.git.savannah.gnu.org/git/findutils.git'
      tag: 'v4.10.0'
      version: '4.10.0'
      sources_required:
        - gnulib
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['python3', '@SOURCE_ROOT@/scripts/checkout-gnulib.py', '@SOURCE_ROOT@/ports/gnulib']
        - args: ['./bootstrap', '--skip-po']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
      - host-python
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--without-selinux'
        - '--disable-nls'
        - '--localstatedir=/var/lib/locate'
        environ:
          'PYTHON': '@BUILD_ROOT@/tools/host-python/bin/python3'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['@SOURCE_ROOT@/scripts/keep-empty-directories.py', '@THIS_COLLECT_DIR@']

  - name: gawk
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/gawk.git'
      tag: 'gawk-4.2.1'
      version: '4.2.1'
      tools_required:
          - 'cross-autoconf-v2.69'
          - 'cross-automake-v1.15'
      regenerate:
        - args: sed -i 's/extras//' @THIS_SOURCE_DIR@/Makefile.in
        - args: ['cp', '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub', '@THIS_SOURCE_DIR@/']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args: ['@THIS_SOURCE_DIR@/configure', '--host=@OPTION:arch-triple@', '--prefix=/usr', '--disable-nls', '--disable-extensions']
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: grep
    labels: [aarch64, riscv64]
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    metadata:
      summary: GNU regular expression matcher
      description: This package contains programs for searching through the contents of files.
      spdx: 'GPL-3.0-or-later'
      website: 'https://www.gnu.org/software/grep/'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['sys-apps']
    source:
      subdir: ports
      git: 'https://https.git.savannah.gnu.org/git/grep.git'
      tag: 'v3.11'
      version: '3.11'
      sources_required:
        - gnulib
      tools_required:
        - cross-autoconf-v2.69
        - cross-automake-v1.15
      regenerate:
        - args: ['python3', '@SOURCE_ROOT@/scripts/checkout-gnulib.py', '@SOURCE_ROOT@/ports/gnulib']
        - args: ['./bootstrap', '--skip-po']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
      # - virtual: pkgconfig-for-target
      #   triple: '@OPTION:arch-triple@'
    pkgs_required:
      - mlibc
      - pcre2
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-nls'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/lib/Makefile'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/src/Makefile'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: groff
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/groff.git'
      tag: '1.22.4'
      version: '1.22.4'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-doc=no'
        environ:
          PAGE: 'A4'
      - args: 'sed -i s/"_GL_MATH_CXX_REAL_FLOATING_DECL_1 (signbit)"//g @THIS_SOURCE_DIR@/lib/math.in.h'
      - args: 'sed -i s/"_GL_MATH_CXX_REAL_FLOATING_DECL_2 (signbit)"//g @THIS_SOURCE_DIR@/lib/math.in.h'
      - args: 'sed -i s/"#   undef signbit"//g @THIS_SOURCE_DIR@/lib/math.in.h'
    build:
      - args: ['make', '-j1']
        environ:
          xpmtoppm: '/usr/bin/true'
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: iana-etc
    architecture: 'noarch'
    stability_level: 'broken'
    source:
      subdir: ports
      url: 'https://github.com/Mic92/iana-etc/releases/download/20230810/iana-etc-20230810.tar.gz'
      extract_path: 'iana-etc-20230810'
      format: 'tar.gz'
      version: '20230810'
    revision: 1
    build:
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc']
      - args: ['cp', '@THIS_SOURCE_DIR@/services', '@THIS_COLLECT_DIR@/etc/']
      - args: ['cp', '@THIS_SOURCE_DIR@/protocols', '@THIS_COLLECT_DIR@/etc/']

  - name: iproute2
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.kernel.org/pub/scm/network/iproute2/iproute2.git'
      tag: 'v5.18.0'
      version: '5.18.0'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--include_dir=@THIS_SOURCE_DIR@/include'
        environ:
          SBINDIR: '/usr/sbin'
          CC: '@OPTION:arch-triple@-gcc'
          CXX: '@OPTION:arch-triple@-g++'
      - args: ['rm', '-r', 'include/netinet']
    build:
      - args: ['make', '-j@PARALLELISM@']
        environ:
          SBINDIR: '/usr/sbin'
      - args: ['make', 'install']
        environ:
          SBINDIR: '/usr/sbin'
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: kmscon
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: 'ports'
      git: 'https://github.com/dvdhrm/kmscon.git'
      tag: 'kmscon-8'
      version: '8'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
          environ:
            'NOCONFIGURE': '1'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - eudev
      - libdrm
      - libtsm
      - libxkbcommon
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--with-video=drm2d'
        - '--with-renderers='
        - '--with-fonts=unifont'
        - '--disable-multi-seat'
        - '--with-sessions=dummy,terminal'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc/kmscon']
      - args: ['cp', '@SOURCE_ROOT@/meta-sources/base-files/kmscon.conf', '@THIS_COLLECT_DIR@/etc/kmscon/']

  - name: kmod
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.kernel.org/pub/scm/utils/kernel/kmod/kmod.git'
      tag: 'v29'
      version: '29'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./autogen.sh']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - openssl
      - xz-utils
      - zlib
      - zstd
    revision: 1
    configure:
      # - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--with-openssl'
        - '--with-xz'
        - '--with-zstd'
        - '--with-zlib'
        - '--disable-manpages'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
      - args: ['mkdir', '-pv', '@THIS_COLLECT_DIR@/usr/sbin']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/sbin/depmod']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/sbin/insmod']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/sbin/modinfo']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/sbin/modprobe']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/sbin/rmmod']
      - args: ['ln', '-svn', 'kmod', '@THIS_COLLECT_DIR@/usr/bin/lsmod']

  - name: less
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      url: 'http://www.greenwoodsoftware.com/less/less-563.tar.gz'
      format: 'tar.gz'
      extract_path: 'less-563'
      version: '563'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - ncurses
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']

  - name: man-db
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://git.savannah.gnu.org/git/man-db.git'
      tag: '2.9.4'
      version: '2.9.4'
      tools_required:
        - cross-toolchain
      regenerate:
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - gdbm
      - groff
      - less
      - libpipeline
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-nls'
        - '--docdir=/usr/share/doc/man-db-2.9.4'
        - '--sysconfdir=/etc'
        - '--disable-setuid'
        - '--with-systemdtmpfilesdir='
        - '--with-systemdsystemunitdir='
        - '--disable-manual'
        - '--with-pager=/usr/bin/less'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: neofetch
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://github.com/64/neofetch.git'
      branch: 'master'
      commit: 'd27a0bd748310d8ace673a614f745303b444e00e'
      version: '7.2.0'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
    build:
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: shadow
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://github.com/shadow-maint/shadow.git'
      tag: '4.14.0'
      version: '4.14.0'
      tools_required:
        - cross-toolchain
        - host-gettext
      regenerate:
        - args: ['autoreconf', '-v', '-f', '--install']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
      - libiconv
      - libintl
      - libxcrypt
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--exec-prefix=/usr'
        - '--sysconfdir=/etc'
        - '--disable-static'
        - '--enable-shared'
        - '--disable-nls'
        - '--without-audit'
        - '--without-libpam'
        - '--without-btrfs'
        - '--without-selinux'
        - '--without-acl'
        - '--without-attr'
        - '--without-skey'
        - '--without-tcb'
        - '--without-libcrack'
        - '--without-nscd'
        - '--without-sssd'
        - '--without-libbsd'
        - '--with-group-name-max-length=32'
        - '--disable-man'
        environ:
          ac_cv_func_fsync: 'no'
          ac_cv_header_sys_capability_h: 'no'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: sysvinit
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      git: 'https://github.com/slicer69/sysvinit.git'
      tag: '3.04'
      version: '3.04'
      patch-path-strip: 1
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      # - args:
      #   - '@THIS_SOURCE_DIR@/configure'
      #   - '--host=@OPTION:arch-triple@'
      #   - '--prefix=/usr'
      #   - '--sysconfdir=/etc'
    build:
      - args: ['make', '-j@PARALLELISM@', 'CFLAGS=-O2 -ggdb']
        environ:
          CC: '@OPTION:arch-triple@-gcc'
      - args: ['make', 'ROOT=@THIS_COLLECT_DIR@', 'install']
      - args: ['cp', '-v', '@THIS_SOURCE_DIR@/../../meta-sources/base-files/inittab', '@THIS_COLLECT_DIR@/etc/inittab']
      - args: ['cp', '-v', '@THIS_SOURCE_DIR@/../../meta-sources/base-files/fstab', '@THIS_COLLECT_DIR@/etc/fstab']

  - name: systemd
    architecture: '@OPTION:arch@'
    metadata:
      summary: System and service manager for Linux and Managarm
      description: systemd is a suite of basic building blocks for a Linux system. It provides a system and service manager that runs as PID 1 and starts the rest of the system.
      spdx: 'GPL-2.0-only'
      website: 'https://systemd.io'
      maintainer: "no92 <leo@managarm.org> && Dennis Bonke <dennis@managarm.org>"
      categories: ['sys-apps']
    source:
      subdir: 'ports'
      git: 'https://github.com/systemd/systemd.git'
      tag: 'v259'
      version: '259'
    tools_required:
      - cross-toolchain
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
    pkgs_required:
      - acl
      - libatomic
      - libblkid
      - libcap
      - libintl
      - libmount
      - libxcrypt
      # - shadow
      - openssl
      - util-linux-libs
      - mlibc
      - pam
    revision: 1
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--native-file'
        - '@SOURCE_ROOT@/scripts/meson.native-file'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
        - '--prefix=/usr'
        - '--buildtype=release'
        - '-Dlibc=mlibc'
        - '-Dmode=release'
        - '-Dadm-group=false'
        - '-Danalyze=false'
        - '-Dapparmor=disabled'
        - '-Daudit=disabled'
        - '-Dbacklight=false'
        - '-Dbootloader=disabled'
        - '-Dbinfmt=false'
        - '-Dbpf-framework=disabled'
        - '-Dbzip2=disabled'
        - '-Dcoredump=false'
        - '-Ddbus=disabled'
        - '-Defi=false'
        - '-Delfutils=disabled'
        - '-Denvironment-d=false'
        - '-Dfdisk=disabled'
        - '-Dgcrypt=disabled'
        - '-Dglib=disabled'
        - '-Dgshadow=false'
        - '-Dgnutls=disabled'
        - '-Dhibernate=false'
        - '-Dhostnamed=false'
        - '-Didn=false'
        - '-Dima=false'
        - '-Dinitrd=false'
        - '-Dfirstboot=false'
        - '-Dldconfig=false'
        - '-Dlibcryptsetup=disabled'
        - '-Dlibcurl=disabled'
        - '-Dlibfido2=disabled'
        - '-Dlibidn=disabled'
        - '-Dlibidn2=disabled'
        - '-Dlibiptc=disabled'
        - '-Dlocaled=true'
        - '-Dlogind=true'
        - '-Dlz4=disabled'
        - '-Dmachined=false'
        - '-Dmicrohttpd=disabled'
        - '-Dnetworkd=false'
        - '-Dnss-myhostname=false'
        - '-Dnss-resolve=disabled'
        - '-Dnss-systemd=false'
        - '-Doomd=false'
        - '-Dopenssl=disabled'
        - '-Dp11kit=disabled'
        - '-Dpam=enabled'
        - '-Dpcre2=disabled'
        - '-Dpolkit=disabled'
        - '-Dportabled=false'
        - '-Dpstore=false'
        - '-Dpwquality=disabled'
        - '-Drandomseed=false'
        - '-Dresolve=false'
        - '-Drfkill=false'
        - '-Dseccomp=disabled'
        - '-Dsmack=false'
        - '-Dsysext=false'
        - '-Dtimedated=false'
        - '-Dtimesyncd=false'
        - '-Dtpm=false'
        - '-Dqrencode=disabled'
        - '-Dquotacheck=false'
        - '-Duserdb=false'
        - '-Dutmp=true'
        - '-Dvconsole=false'
        - '-Dwheel-group=false'
        - '-Dxdg-autostart=false'
        - '-Dxkbcommon=disabled'
        - '-Dxz=disabled'
        - '-Dzlib=disabled'
        - '-Dzstd=disabled'
        - '-Dtests=true'
        - '-Dinstall-tests=true'
        - '-Dsysusers=false'
        - '-Drpmmacrosdir=no'
        - '-Dhomed=disabled'
        - '-Dpamconfdir=no'
        - '-Ddev-kvm-mode=0660'
        - '-Dnobody-group=nogroup'
        - '-Dsysupdate=disabled'
        - '-Dukify=disabled'
        - '-Ddocdir=/usr/share/doc/systemd-259'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      # Install PAM files
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc/pam.d']
      - args: ['cp', '@SOURCE_ROOT@/extrafiles/pam/systemd-user', '@THIS_COLLECT_DIR@/etc/pam.d/']
      # Touch up empty directories
      - args: ['touch',
          '@THIS_COLLECT_DIR@/usr/lib/systemd/user-generators/.keep',
          '@THIS_COLLECT_DIR@/usr/lib/systemd/system-shutdown/.keep',
          '@THIS_COLLECT_DIR@/usr/lib/systemd/system-sleep/.keep',
          '@THIS_COLLECT_DIR@/etc/credstore.encrypted/.keep',
          '@THIS_COLLECT_DIR@/etc/kernel/install.d/.keep',
          '@THIS_COLLECT_DIR@/etc/systemd/network/.keep',
          '@THIS_COLLECT_DIR@/etc/systemd/system/.keep',
          '@THIS_COLLECT_DIR@/usr/lib/credstore/.keep',
          '@THIS_COLLECT_DIR@/etc/udev/rules.d/.keep',
          '@THIS_COLLECT_DIR@/etc/systemd/user/.keep',
          '@THIS_COLLECT_DIR@/var/log/journal/.keep',
          '@THIS_COLLECT_DIR@/var/lib/systemd/.keep',
          '@THIS_COLLECT_DIR@/etc/tmpfiles.d/.keep',
          '@THIS_COLLECT_DIR@/etc/credstore/.keep',
          '@THIS_COLLECT_DIR@/etc/sysctl.d/.keep',
          '@THIS_COLLECT_DIR@/etc/kernel/.keep'
        ]
      - args: ['ln', '-sr', '@THIS_COLLECT_DIR@/usr/lib', '@THIS_COLLECT_DIR@/lib']
      - args: ['systemd-hwdb', '--usr', '-r', '@THIS_COLLECT_DIR@', 'update']
      - args: ['systemd-machine-id-setup', '--root=@SYSROOT_DIR@']
      - args: ['rm', '@THIS_COLLECT_DIR@/lib']

  - name: util-linux-libs
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    from_source: util-linux
    tools_required:
      - cross-toolchain
      - virtual: pkgconfig-for-target
        triple: '@OPTION:arch-triple@'
    pkgs_required:
      - mlibc
      - file
      - libiconv
      - ncurses
      - readline
      - zlib
    revision: 1
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--buildtype=debugoptimized'
        - '--default-library=shared'
        - '-Dfs-search-path-extra=/usr/sbin:/bin:/usr/bin'
        - '-Dbuild-python=disabled'
        - '-Dbuild-bits=disabled'
        - '-Dbuild-ldattach=disabled'
        - '-Dbuild-lscpu=disabled'
        - '-Dbuild-unshare=disabled'
        - '-Dbuild-nsenter=disabled'
        - '-Dbuild-ipcrm=disabled'
        - '-Dbuild-ipcs=disabled'
        - '-Dbuild-lsfd=disabled'
        - '-Dbuild-fdisks=disabled'
        - '-Dbuild-mount=disabled'
        - '-Dbuild-swapon=disabled'
        - '-Dbuild-swapoff=disabled'
        - '-Dbuild-liblastlog2=disabled'
        - '-Dbuild-chcpu=disabled'
        - '-Dbuild-losetup=disabled'
        - '-Dbuild-zramctl=disabled'
        - '-Dbuild-lsns=disabled'
        - '-Dbuild-mkfs=disabled'
        - '-Dbuild-fsck=disabled'
        - '-Dbuild-partx=disabled'
        - '-Dbuild-script=disabled'
        - '-Dbuild-scriptutils=disabled'
        - '-Dbuild-col=disabled'
        - '-Dbuild-colcrt=disabled'
        - '-Dbuild-colrm=disabled'
        - '-Dbuild-rev=disabled'
        - '-Dbuild-uuidd=disabled'
        - '-Dbuild-choom=disabled'
        - '-Dbuild-isosize=disabled'
        - '-Dbuild-waitpid=disabled'
        - '-Dbuild-wipefs=disabled'
        - '-Dbuild-mountpoint=disabled'
        - '-Dbuild-fallocate=disabled'
        - '-Dbuild-setpriv=disabled'
        - '-Dbuild-hardlink=disabled'
        - '-Dbuild-eject=disabled'
        - '-Dbuild-agetty=disabled'
        - '-Dbuild-cramfs=disabled'
        - '-Dbuild-bfs=disabled'
        - '-Dbuild-minix=disabled'
        - '-Dbuild-fdformat=disabled'
        - '-Dbuild-blockdev=disabled'
        - '-Dbuild-hwclock=disabled'
        - '-Dbuild-lslogins=disabled'
        - '-Dbuild-wdctl=disabled'
        - '-Dbuild-cal=disabled'
        - '-Dbuild-logger=disabled'
        - '-Dbuild-look=disabled'
        - '-Dbuild-mcookie=disabled'
        - '-Dbuild-namei=disabled'
        - '-Dbuild-whereis=disabled'
        - '-Dbuild-lsblk=disabled'
        - '-Dbuild-lslocks=disabled'
        - '-Dbuild-findmnt=disabled'
        - '-Dbuild-switch_root=disabled'
        - '-Dbuild-pivot_root=disabled'
        - '-Dbuild-flock=disabled'
        - '-Dbuild-lsmem=disabled'
        - '-Dbuild-lsirq=disabled'
        - '-Dbuild-irqtop=disabled'
        - '-Dbuild-chmem=disabled'
        - '-Dbuild-ipcmk=disabled'
        - '-Dbuild-ipcrm=disabled'
        - '-Dbuild-ipcs=disabled'
        - '-Dbuild-rfkill=disabled'
        - '-Dbuild-tunelp=disabled'
        - '-Dbuild-fstrim=disabled'
        - '-Dbuild-dmesg=disabled'
        - '-Dbuild-ctrlaltdel=disabled'
        - '-Dbuild-exch=disabled'
        - '-Dbuild-fsfreeze=disabled'
        - '-Dbuild-blkdiscard=disabled'
        - '-Dbuild-blkzone=disabled'
        - '-Dbuild-blkpr=disabled'
        - '-Dbuild-rtcwake=disabled'
        - '-Dbuild-setarch=disabled'
        - '-Dbuild-kill=disabled'
        - '-Dbuild-last=disabled'
        - '-Dbuild-utmpdump=disabled'
        - '-Dbuild-line=disabled'
        - '-Dbuild-mesg=disabled'
        - '-Dbuild-line=disabled'
        - '-Dbuild-mesg=disabled'
        - '-Dbuild-raw=disabled'
        - '-Dbuild-rename=disabled'
        - '-Dbuild-vipw=disabled'
        - '-Dbuild-newgrp=disabled'
        - '-Dbuild-chfn-chsh=disabled'
        - '-Dbuild-login=disabled'
        - '-Dbuild-nologin=disabled'
        - '-Dbuild-sulogin=disabled'
        - '-Dbuild-su=disabled'
        - '-Dbuild-runuser=disabled'
        - '-Dbuild-ul=disabled'
        - '-Dbuild-more=disabled'
        - '-Dbuild-pg=disabled'
        - '-Dbuild-pipesz=disabled'
        - '-Dbuild-fadvise=disabled'
        - '-Dbuild-enosys=disabled'
        - '-Dbuild-lsclocks=disabled'
        - '-Dbuild-getopt=disabled'
        - '-Dbuild-setterm=disabled'
        - '-Dbuild-schedutils=disabled'
        - '-Dbuild-wall=disabled'
        - '-Dbuild-write=disabled'
        - '-Dbuild-bash-completion=disabled'
        - '-Dbuild-pylibmount=disabled'
        - '-Dbuild-hexdump=disabled'
        - '-Dbuild-findfs=disabled'
        - '-Dprogram-tests=false'
        - '-Dnls=disabled'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['rm', '-rf', '@THIS_COLLECT_DIR@/usr/bin']
      - args: ['rm', '-rf', '@THIS_COLLECT_DIR@/usr/sbin']
    subpackages:
      # We need to add /usr/lib and /usr/lib64, because riscv doesn't use lib64 but aarch64 and amd64 do.
      - name: libblkid
        include: ['/usr/lib*/libblkid*', '/usr/include/blkid/*', '/usr/lib*/pkgconfig/blkid*', '/usr/share/man/man3/libblkid.3']
      - name: libmount
        include: ['/usr/lib*/libmount*', '/usr/include/libmount/*', '/usr/lib*/pkgconfig/mount*']
      - name: libsmartcols
        include: ['/usr/lib*/libsmartcols*', '/usr/include/libsmartcols/*', '/usr/lib*/pkgconfig/smartcols*', '/usr/share/man/man5/terminal-colors.d.5']
      - name: libuuid
        include: ['/usr/lib*/libuuid*', '/usr/include/uuid/*', '/usr/lib*/pkgconfig/uuid*', '/usr/share/man/man3/uuid*']
      - name: libfdisk
        include: ['/usr/lib*/libfdisk*', '/usr/include/libfdisk/*', '/usr/lib*/pkgconfig/fdisk*']

  - name: which
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    source:
      subdir: ports
      url: 'https://ftpmirror.gnu.org/gnu/which/which-2.21.tar.gz'
      format: 'tar.gz'
      extract_path: 'which-2.21'
      version: '2.21'
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: sed
    labels: [aarch64, riscv64]
    architecture: '@OPTION:arch@'
    stability_level: 'broken'
    metadata:
      summary: Super-useful stream editor
      description: This package contains a stream editor.
      spdx: 'GPL-3.0-or-later'
      website: 'https://www.gnu.org/software/sed/'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['sys-apps']
    source:
      subdir: ports
      git: 'https://https.git.savannah.gnu.org/git/sed.git'
      tag: 'v4.9'
      version: '4.9'
      sources_required:
        - gnulib
      tools_required:
        - cross-autoconf-v2.69
        - cross-automake-v1.15
        - cross-libtool
      regenerate:
        - args: ['python3', '@SOURCE_ROOT@/scripts/checkout-gnulib.py', '@SOURCE_ROOT@/ports/gnulib']
        - args: ['./bootstrap', '--skip-po']
        - args: ['cp',
            '@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - cross-toolchain
    pkgs_required:
      - mlibc
    revision: 1
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-nls'
        - '--disable-gcc-warnings'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
